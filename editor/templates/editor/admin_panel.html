<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>Panel Admin | Bingo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
        }
        .admin-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 15px;
            padding: 30px;
        }
        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: #38bdf8;
        }
        .info-box {
            background: #111;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .ball-display {
            font-size: 4rem;
            text-align: center;
            color: #22c55e;
            font-weight: bold;
            margin: 20px 0;
        }
        .btn {
            background: #3b82f6;
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #2563eb;
            transform: scale(1.02);
        }
        .btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .drawn-balls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .mini-ball {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .status {
            text-align: center;
            padding: 10px;
            background: #444;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>ðŸŽ® PANEL DE ADMIN</h1>
        
        <div class="status">
            Partida #{{ partida_id }} | Balotas sorteadas: <span id="count">0</span>/75
        </div>

        <div class="info-box">
            <h3 style="color: #38bdf8; margin-bottom: 15px;">Ãšltima Balota</h3>
            <div id="current-ball" class="ball-display">--</div>
        </div>

        <button id="btn-draw" class="btn">SORTEAR BALOTA</button>
        <button id="btn-auto" class="btn" style="background: #8b5cf6;">INICIAR AUTO-PLAY (10s)</button>
        <button id="btn-reset" class="btn btn-danger">REINICIAR JUEGO</button>

        <div class="info-box">
            <h3 style="color: #38bdf8; margin-bottom: 15px;">Historial</h3>
            <div id="history" class="drawn-balls"></div>
        </div>
    </div>

    <script>
        const PARTIDA_ID = {{ partida_id }};
        let drawnBalls = [];
        let autoPlayInterval = null;

        document.getElementById('btn-draw').onclick = drawBall;
        
        document.getElementById('btn-auto').onclick = () => {
            const btn = document.getElementById('btn-auto');
            if (autoPlayInterval) {
                // Stop Auto-Play
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
                btn.textContent = "INICIAR AUTO-PLAY (10s)";
                btn.style.background = "#8b5cf6";
                document.getElementById('btn-draw').disabled = false;
            } else {
                // Start Auto-Play
                drawBall(); // Draw immediately
                autoPlayInterval = setInterval(drawBall, 10000); // Then every 10s
                btn.textContent = "DETENER AUTO-PLAY";
                btn.style.background = "#ef4444";
                document.getElementById('btn-draw').disabled = true;
            }
        };

        async function drawBall() {
            const response = await fetch('/panel/sortear-balota/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ partida_id: PARTIDA_ID })
            });
            
            const data = await response.json();
            if (data.number) {
                addBall(data.number);
            } else if (data.error) {
                alert(data.error);
                if (autoPlayInterval) document.getElementById('btn-auto').click(); // Stop if error
            }
        }

        document.getElementById('btn-reset').onclick = async () => {
            if (!confirm('Â¿Seguro que quieres reiniciar el juego?')) return;
            
            if (autoPlayInterval) document.getElementById('btn-auto').click(); // Stop auto-play
            
            const response = await fetch('/panel/reiniciar-juego/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            console.log('Reset response:', data);
            
            if (data.success) {
                alert('Juego reiniciado. Los jugadores conectados deberÃ­an recargarse automÃ¡ticamente.');
                drawnBalls = [];
                document.getElementById('current-ball').textContent = '--';
                document.getElementById('history').innerHTML = '';
                document.getElementById('count').textContent = '0';
            } else {
                alert('Error: ' + (data.error || 'Desconocido'));
            }
        };

        function addBall(number) {
            drawnBalls.push(number);
            document.getElementById('current-ball').textContent = number;
            document.getElementById('count').textContent = drawnBalls.length;
            
            const mini = document.createElement('div');
            mini.classList.add('mini-ball');
            mini.textContent = number;
            document.getElementById('history').prepend(mini);
            
            if (drawnBalls.length >= 75) {
                document.getElementById('btn-draw').disabled = true;
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
