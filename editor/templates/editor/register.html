<!DOCTYPE html>
<html lang="es">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create an account - Bingo</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Estilos (mantuve tu estética y añadí clases para errores y accesibilidad) -->
    <style>
        :root {
            --primary-color: #6c5dd3;
            --primary-hover: #5a4cb4;
            --text-color: #333;
            --text-secondary: #888;
            --border-color: #e0e0e0;
            --bg-color: #fff;
            --input-bg: #fff;
            --error-color: #e74c3c;
            --success-color: #16a34a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Poppins', sans-serif; color: var(--text-color); }

        .container { display: flex; min-height: 100vh; }

        /* Left visual */
        .image-section { flex: 1; background: linear-gradient(135deg,#4f46e5,#06b6d4); display: flex; align-items: center; justify-content: center; }
        .cover-image { width: 100%; height: 100%; object-fit: cover; display: block; opacity: 0.95; }

        /* Right form */
        .form-section { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2.25rem; background: var(--bg-color); }
        .form-wrapper { width: 100%; max-width: 520px; }

        .logo-image { width: 160px; height: auto; display: block; margin: 0 auto 1rem; }
        h1 { font-size: 1.75rem; margin-bottom: 0.75rem; text-align: center; }
        p.lead { color: var(--text-secondary); text-align: center; margin-bottom: 1rem; }

        .google-btn { width: 100%; display:flex; gap:12px; align-items:center; justify-content:center; padding:0.75rem; border-radius:12px; border:1px solid var(--border-color); background:#fff; cursor:pointer; font-weight:600; }
        .google-btn i { font-size:1.1rem; }

        .divider { display:flex; align-items:center; gap:12px; margin:1.25rem 0; color:var(--text-secondary); }
        .divider::before, .divider::after { content:''; flex:1; height:1px; background:var(--border-color); }

        form { background:transparent; }
        .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .input-group { margin-bottom: 0.95rem; text-align:left; }
        label { display:block; font-size:0.9rem; margin-bottom:6px; color:var(--text-secondary); }

        input[type=text], input[type=password], input[type=email] {
            width:100%; padding:0.85rem 0.9rem; border-radius:12px; border:1px solid var(--border-color); background:var(--input-bg); font-size:1rem; outline:none; transition:border-color .15s, box-shadow .12s;
        }
        input:focus { border-color:var(--primary-color); box-shadow: 0 4px 14px rgba(108,93,211,0.08); }

        .password-wrapper { position:relative; }
        .toggle-password { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--text-secondary); }

        .submit-btn { width:100%; padding:0.95rem; border-radius:30px; background:var(--primary-color); color:#fff; border:none; font-weight:700; cursor:pointer; margin-top:8px; }
        .submit-btn:disabled { opacity:0.6; cursor:not-allowed; }

        .helper { font-size:0.9rem; color:var(--text-secondary); margin-top:8px; }
        .login-text { margin-top:1rem; text-align:center; }

        .error-msg { color:var(--error-color); font-size:0.85rem; margin-top:6px; }
        .success-msg { color:var(--success-color); font-size:0.85rem; margin-top:6px; }

        input.error { border-color:var(--error-color); }

        /* small responsive tweaks */
        @media (max-width: 900px) { .container { flex-direction:column; } .image-section { height:220px; } }

        /* accessibility focus outlines */
        a:focus, button:focus, input:focus { outline:3px solid rgba(99,102,241,0.12); }

        /* small note area for server errors */
        .server-errors { background: #fff5f5; border:1px solid rgba(231,76,60,0.12); padding:10px 12px; border-radius:8px; margin-bottom:10px; }
    </style>
</head>

<body>

<div class="container">
    <div class="image-section" aria-hidden="true">
        <img src="{% static 'imagenes/fondo2.webp' %}" alt="Fondo decorativo" class="cover-image">
    </div>

    <div class="form-section">
        <div class="form-wrapper">

            <img src="{% static 'imagenes/logo.png' %}" alt="Logo Bingo" class="logo-image">

            <h1>Crear cuenta</h1>
            <p class="lead">Regístrate con tu usuario y contraseña para unirte al Bingo.</p>

            <!-- Mensajes del servidor (ej. errores no campo específicos) -->
            {% if form.non_field_errors %}
            <div class="server-errors" role="alert">
                {% for err in form.non_field_errors %}
                    <div>{{ err }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- FORMULARIO: usa los campos del UserCreationForm -->
            <form method="POST" novalidate id="registerForm">
                {% csrf_token %}

                <div class="input-group">
                    <label for="id_username">Usuario</label>
                    {{ form.username }}
                    {% if form.username.errors %}
                        <div class="error-msg" role="alert">{{ form.username.errors.0 }}</div>
                    {% endif %}
                    <div class="helper" id="usernameHelp">Mínimo 4 caracteres. Solo letras, números y guion bajo.</div>
                </div>

                <div class="input-group password-wrapper">
                    <label for="id_password1">Contraseña</label>
                    {{ form.password1 }}
                    <i class="fa-regular fa-eye-slash toggle-password" id="togglePassword" aria-hidden="true"></i>
                    {% if form.password1.errors %}
                        <div class="error-msg" role="alert">{{ form.password1.errors.0 }}</div>
                    {% endif %}
                    <div class="helper" id="passwordHelp">Al menos 8 caracteres. Usa mayúsculas, minúsculas y números.</div>
                    <div id="pwdStrength" class="helper" aria-live="polite"></div>
                </div>

                <div class="input-group">
                    <label for="id_password2">Repetir contraseña</label>
                    {{ form.password2 }}
                    {% if form.password2.errors %}
                        <div class="error-msg" role="alert">{{ form.password2.errors.0 }}</div>
                    {% endif %}
                    <div id="pwdMatch" class="helper" aria-live="polite"></div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Crear cuenta</button>

            </form>

            <p class="login-text">¿Ya tienes cuenta? <a href="{% url 'login' %}">Iniciar sesión</a></p>

        </div>
    </div>
</div>


<script>
// Validación en vivo (cliente) + visualizaciones, sin reemplazar backend
(function(){
    const username = document.getElementById('id_username');
    const pwd1 = document.getElementById('id_password1');
    const pwd2 = document.getElementById('id_password2');
    const toggle = document.getElementById('togglePassword');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('registerForm');
    const pwdStrength = document.getElementById('pwdStrength');
    const pwdMatch = document.getElementById('pwdMatch');

    // helper funcs
    function setError(el, msg){
        el.classList.add('error');
        let s = el.parentElement.querySelector('.error-msg');
        if(!s){ s = document.createElement('div'); s.className='error-msg'; el.parentElement.appendChild(s);} 
        s.textContent = msg;
    }
    function clearError(el){ el.classList.remove('error'); const s = el.parentElement.querySelector('.error-msg'); if(s) s.remove(); }

    function evaluatePassword(p){
        let score = 0;
        if(p.length >= 8) score += 1;
        if(/[A-Z]/.test(p)) score += 1;
        if(/[a-z]/.test(p)) score += 1;
        if(/[0-9]/.test(p)) score += 1;
        if(/[^A-Za-z0-9]/.test(p)) score += 1;
        return score; // 0-5
    }

    function strengthText(score){
        if(score <= 1) return 'Muy débil';
        if(score === 2) return 'Débil';
        if(score === 3) return 'Aceptable';
        if(score === 4) return 'Fuerte';
        return 'Excelente';
    }

    // username live check: min length + allowed chars
    username && username.addEventListener('input', ()=>{
        const v = username.value.trim();
        clearError(username);
        if(v.length > 0 && v.length < 4){ setError(username, 'Usuario muy corto (mínimo 4 caracteres).'); }
        else if(!/^[A-Za-z0-9_]+$/.test(v) && v.length>0){ setError(username, 'Solo letras, números y guion bajo.'); }
    });

    // password strength
    pwd1 && pwd1.addEventListener('input', ()=>{
        const v = pwd1.value;
        const s = evaluatePassword(v);
        pwdStrength.textContent = 'Fortaleza: ' + strengthText(s);
        if(s <= 1) { pwdStrength.style.color = 'var(--error-color)'; }
        else if(s <= 3) { pwdStrength.style.color = '#f59e0b'; }
        else { pwdStrength.style.color = 'var(--success-color)'; }

        // clear server-side errors visually if user types
        clearError(pwd1);
    });

    // password match
    function checkMatch(){
        if(!pwd2) return;
        if(pwd2.value.length === 0){ pwdMatch.textContent = ''; return; }
        if(pwd1.value === pwd2.value){ pwdMatch.textContent = 'Contraseñas coinciden.'; pwdMatch.style.color = 'var(--success-color)'; clearError(pwd2); }
        else { pwdMatch.textContent = 'No coinciden.'; pwdMatch.style.color = 'var(--error-color)'; setError(pwd2, 'Las contraseñas no coinciden.'); }
    }
    pwd2 && pwd2.addEventListener('input', checkMatch);
    pwd1 && pwd1.addEventListener('input', checkMatch);

    // toggle password visibility (works for first password input found inside form)
    if(toggle){ toggle.addEventListener('click', ()=>{
        const input = pwd1 || document.querySelector('input[type=password]');
        if(!input) return;
        input.type = input.type === 'password' ? 'text' : 'password';
        toggle.classList.toggle('fa-eye'); toggle.classList.toggle('fa-eye-slash');
    }); }

    // final client-side guard on submit (still relies on server validation)
    form && form.addEventListener('submit', function(e){
        // remove previous inline errors
        [username, pwd1, pwd2].forEach(el=> el && clearError(el));
        let ok = true;
        if(username && username.value.trim().length < 4){ setError(username, 'Usuario muy corto (mínimo 4).'); ok=false; }
        if(pwd1 && pwd1.value.length < 8){ setError(pwd1, 'La contraseña debe tener al menos 8 caracteres.'); ok=false; }
        if(pwd2 && pwd1 && pwd1.value !== pwd2.value){ setError(pwd2, 'Las contraseñas no coinciden.'); ok=false; }
        if(!ok){ e.preventDefault(); window.scrollTo({top:0, behavior:'smooth'}); }
    });

})();
</script>

</body>
</html>